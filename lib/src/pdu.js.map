{"version":3,"sources":["../../src/pdu.js"],"names":["pduHeadParams","PDU","constructor","command","options","Buffer","isBuffer","fromBuffer","command_length","command_id","commands","id","command_status","sequence_number","params","Object","keys","forEach","key","default","type","tlvs","isResponse","response","option","errors","ESME_RINVCMDID","buffer","i","readUInt32BE","bind","offset","maxLength","Error","commandsById","read","size","tlvId","readUInt16BE","length","tlv","tlvsById","slice","tag","tlvMap","multiple","push","_filter","func","filter","call","value","_initBuffer","writeUInt32BE","toBuffer","values","write","writeUInt16BE","fromStream","stream","commandLength","unshift"],"mappings":"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","sourcesContent":["/* eslint-disable no-param-reassign,camelcase,prefer-arrow-callback,space-before-function-paren*/\nimport { commands, commandsById, tlvs, tlvsById, errors } from './defs';\n\nconst pduHeadParams = [\n  'command_length',\n  'command_id',\n  'command_status',\n  'sequence_number',\n];\n\nclass PDU {\n  constructor(command, options = {}) {\n    if (Buffer.isBuffer(command)) {\n      return this.fromBuffer(command);\n    }\n    this.command = command;\n    this.command_length = 0;\n    this.command_id = commands[command].id;\n    this.command_status = options.command_status || 0;\n    this.sequence_number = options.sequence_number || 0;\n    if (this.command_status) {\n      return;\n    }\n    const params = commands[command].params || {};\n    Object.keys(params).forEach((key) => {\n      if (key in options) {\n        this[key] = options[key];\n      } else if ('default' in params[key]) {\n        this[key] = params[key].default;\n      } else {\n        this[key] = params[key].type.default;\n      }\n    });\n\n    Object.keys(options).forEach((key) => {\n      if (key in tlvs) {\n        this[key] = options[key];\n      }\n    });\n  }\n  isResponse() {\n    return !!(this.command_id & 0x80000000);\n  }\n  response(option) {\n    const options = option || {};\n    options.sequence_number = this.sequence_number;\n    if (this.command === 'unknown') {\n      if (!('command_status' in options)) {\n        options.command_status = errors.ESME_RINVCMDID;\n      }\n      return new PDU('generic_nack', options);\n    }\n    return new PDU(`${this.command}_resp`, options);\n  }\n  fromBuffer(buffer) {\n    pduHeadParams.forEach(\n      function(key, i) {\n        this[key] = buffer.readUInt32BE(i * 4);\n      }.bind(this),\n    );\n    let params;\n    let offset = 16;\n    if (this.command_length > PDU.maxLength) {\n      throw Error(\n        `PDU length was too large (${this.command_length}, maximum is ${\n          PDU.maxLength\n        }).`,\n      );\n    }\n    if (commandsById[this.command_id]) {\n      this.command = commandsById[this.command_id].command;\n      params = commands[this.command].params || {};\n    } else {\n      this.command = 'unknown';\n      return;\n    }\n    for (const key of Object.keys(params)) {\n      if (offset >= this.command_length) {\n        break;\n      }\n      this[key] = params[key].type.read(buffer, offset);\n      offset += params[key].type.size(this[key]);\n    }\n    while (offset + 4 <= this.command_length) {\n      const tlvId = buffer.readUInt16BE(offset);\n      const length = buffer.readUInt16BE(offset + 2);\n      offset += 4;\n      const tlv = tlvsById[tlvId];\n      if (!tlv) {\n        this[tlvId] = buffer.slice(offset, offset + length);\n        offset += length;\n        continue; // eslint-disable-line\n      }\n      const tag = (commands[this.command].tlvMap || {})[tlv.tag] || tlv.tag;\n      if (tlv.multiple) {\n        if (!this[tag]) {\n          this[tag] = [];\n        }\n        this[tag].push(tlv.type.read(buffer, offset, length));\n      } else {\n        this[tag] = tlv.type.read(buffer, offset, length);\n      }\n      offset += length;\n    }\n    this._filter('decode');\n  }\n  _filter(func) {\n    const params = commands[this.command].params || {};\n    for (const key of Object.keys(this)) {\n      if (params[key] && params[key].filter) {\n        this[key] = params[key].filter[func].call(this, this[key]);\n      } else if (tlvs[key] && tlvs[key].filter) {\n        if (tlvs[key].multiple) {\n          this[key].forEach(\n            function(value, i) {\n              this[key][i] = tlvs[key].filter[func].call(this, value);\n            }.bind(this),\n          );\n        } else {\n          this[key] = tlvs[key].filter[func].call(this, this[key]);\n        }\n      }\n    }\n  }\n  _initBuffer() {\n    const buffer = new Buffer(this.command_length);\n    pduHeadParams.forEach(\n      function(key, i) {\n        buffer.writeUInt32BE(this[key], i * 4);\n      }.bind(this),\n    );\n    return buffer;\n  }\n  toBuffer() {\n    this.command_length = 16;\n    if (this.command_status) {\n      return this._initBuffer();\n    }\n    this._filter('encode');\n    const params = commands[this.command].params || {};\n    for (const key of Object.keys(this)) {\n      if (params[key]) {\n        this.command_length += params[key].type.size(this[key]);\n      } else if (tlvs[key]) {\n        const values = tlvs[key].multiple ? this[key] : [this[key]];\n        values.forEach(\n          function(value) {\n            this.command_length += tlvs[key].type.size(value) + 4;\n          }.bind(this),\n        );\n      }\n    }\n    const buffer = this._initBuffer();\n    let offset = 16;\n    for (const key of Object.keys(params)) {\n      params[key].type.write(this[key], buffer, offset);\n      offset += params[key].type.size(this[key]);\n    }\n    for (const key of Object.keys(this)) {\n      if (tlvs[key]) {\n        const values = tlvs[key].multiple ? this[key] : [this[key]];\n\n        values.forEach(function(value) {\n          buffer.writeUInt16BE(tlvs[key].id, offset);\n          const length = tlvs[key].type.size(value);\n          buffer.writeUInt16BE(length, offset + 2);\n          offset += 4;\n          tlvs[key].type.write(value, buffer, offset);\n          offset += length;\n        });\n      }\n    }\n    return buffer;\n  }\n  static fromStream(stream) {\n    let buffer = stream.read(4);\n    if (!buffer) {\n      return false;\n    }\n    const commandLength = buffer.readUInt32BE(0);\n    if (commandLength > PDU.maxLength) {\n      throw Error(\n        `PDU length was too large (${commandLength}, maximum is ${\n          PDU.maxLength\n        }).`,\n      );\n    }\n    stream.unshift(buffer);\n    buffer = stream.read(commandLength);\n    if (!buffer) {\n      return false;\n    }\n    return new PDU(buffer);\n  }\n  static fromBuffer(buffer) {\n    if (buffer.length < 16 || buffer.length < buffer.readUInt32BE(0)) {\n      return false;\n    }\n    return new PDU(buffer);\n  }\n}\n\nPDU.maxLength = 16384;\n\nexport { PDU };\n"],"file":"pdu.js"}